<Project>

  <PropertyGroup>
    <DefaultItemExcludes>**\dist\**;**\*.targets;$(DefaultItemExcludes)</DefaultItemExcludes>
  </PropertyGroup>
  
  <ItemGroup>
    <NpmBuildInputs Include="$(NpmFolder)**" Exclude="$(DefaultItemExcludes)" />
  </ItemGroup>

  <!-- If package-lock.json has changed, perform an NPM install -->
  <Target Name="NpmInstall" Inputs="$(NpmFolder)package-lock.json" Outputs="$(NpmFolder)node_modules\.package-lock.json">
    <Message Importance="high" Text="Running npm install..." />
    <Exec Command="npm install" WorkingDirectory="$(NpmFolder)" />
  </Target>

  <Target Name="NpmRunBuild" DependsOnTargets="NpmInstall" BeforeTargets="AssignTargetPaths" Inputs="@(NpmBuildInputs)" Outputs="$(IntermediateOutputPath)npmbuild.complete.txt">
    <Exec Command="$(NpmCommand) -- -o $(IntermediateOutputPath)\npm" WorkingDirectory="$(NpmFolder)" />

    <ItemGroup>
      <_NpmOutput Include="$(IntermediateOutputPath)\npm\**"></_NpmOutput>
      <Content Include="@(_NpmOutput)" Link="wwwroot\%(_NpmOutput.RecursiveDir)\%(_NpmOutput.FileName)%(_NpmOutput.Extension)" />
      <FileWrites Include="$(IntermediateOutputPath)npmbuild.complete.txt" />
    </ItemGroup>

    <GetFileHash Files="@(_NpmOutput)">
      <Output TaskParameter="Items" ItemName="_NpmOutputWithHash" />
    </GetFileHash>
    <WriteLinesToFile File="$(IntermediateOutputPath)npmbuild.complete.txt" Lines="@(_NpmOutputWithHash->'%(Identity): %(FileHash)')" WriteOnlyWhenDifferent="true" />
  </Target>

</Project>
